<html>
<head>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='GMstyle.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='plots.css') }}">

  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src= "http://code.jquery.com/jquery-latest.min.js"></script>
  <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>
</head>

<body>
  <div id="header">
    <div id="img_container">
        <img src="http://www.genesismedia.com/wp-content/themes/genesis/images/logo.svg" onerror="this.onerror=null; this.src='http://www.genesismedia.com/wp-content/themes/genesis/images/logo.png'" style="margin: 35px; width: 400px; height: 90px;">
        <button type="button" id="btn" onclick="submitForm()">Simulate</button>
    </div>
    <h1>SIMULATED BIG SWING MODEL</h1>
  </div>



  <!-- Take rewards associated with reactions to actions as inputs-->
  <br><br>
  <div id="showcase">
    <div id= "input">
      <button id="update_reward_button" class= "btn2">Add Action/Rewards</button>

      <table id= "rewards" class="display" cellspacing="0" width="100%">
          <tr>
            <td><strong>Actions/Reactions</strong></td>
            <td><strong>down ($ Increase in time spent)</strong></td>
            <td><strong>right ($ Increase in #pageviews)<strong></td>
            <td><strong>dead ($ User left)<strong></td>
            <td><strong>Use rate<strong></td>
          </tr>
          <tr class="inputs">
            <td class="action"><input type="text" value="nothing"></td>
            <td class="down"><input type="number" value="2"></td>
            <td class="right"><input type="number" value="2"></td>
            <td class="dead"><input type="number" value="2"></td>
            <td class="use_rate"><input type="number" value="0.6"></td>
          </tr>
      </table>

      <br><br>ALPHA:
      <input type="number" class="vars" name="ALPHA" value=0.5>
      &ensp; GAMMA:
      <input type="number" class="vars" name="GAMMA" value=0.5>
        &ensp;MAX_ATSOP_ROWS:
      <input type="number" class="vars" name="MAX_ATSOP_ROWS" value=10>
      &ensp; MAX_SD_COLS:
      <input type="number" class="vars" name="MAX_SD_COLS" value=5>
      &ensp; ATSOP_GAP(seconds):
      <input type="number" class="vars" name="ATSOP_GAP" value=2>
    </div>

    <div>
      <hr>
    </div>

    <div id= "output">
      <div style="height: 60px;"> <button id="update_results" class= "btn2">Update</button></div>

      <div id="Q" class="results">
        <h3>Q-Actions</h3>
        <!-- Plotly chart will be drawn inside this DIV -->
        <div id="QDiv0" class="Q" style="width:480px; height:400px;"></div>
        <div id="QDiv1" class="Q" style="width:480px; height:400px;"></div>
        <div id="QDiv2" class="Q" style="width:480px; height:400px;"></div>
      </div>

      <hr style="border-top: dotted 1px;" />

      <div id="others" class="results">
        <div id="used_policy" class="minions">
          <h3>Executed Policy</h3>
          <div id="UPolicyDiv" class ="Q" style="width:480px; height:400px;"></div>
        </div>
        <div id="optimum" class="minions">
          <h3>Optimal policy</h3>
          <div id="OPolicyDiv" class ="Q" style="width:480px; height:400px;"></div>
        </div>
        <div id="value" class= "minions">
          <h3>Value Matrix</h3>
          <div id="VDiv" class ="Q" style="width:480px; height:400px;"></div>
        </div>
        <div id="value" class= "minions">
          <h3>Optimal Value Matrix</h3>
          <div id="OVDiv" class ="Q" style="width:480px; height:400px;"></div>
        </div>
      </div>

      <hr style="border-top: dotted 1px;" />

      <div id ='clv' class="results">
        <div id ='lhs'>
        <br><br>$Value\ of\ the\ User\ (\ t\ =\ 1\ month):$
        </div>
          <div id= 'N'>
            $\ \ \ N(t)$ <br><br><br>
            $\ $<input id="N_in" type="number" name="N" value="10" style="width: 45px; border-color:black; text-align:right; height:30px; font-size:15px;" onchange="updateValue(this.value)">
          </div>

          <div id='multiply1'>
            $*$
          </div>

          <div id ='similarity'>
            $Segment\ Similarity$<br><br>
            $direct\ \ :\ 1.0$<br><br>
            $search\ :\ 0.0$<br><br>
            $social\ \ :\ 0.0$<br><br>
          </div>

          <div id='multiply2'>
            $*$
          </div>

          <div id="V1">
            $V(1)$<br><br>
            <div id="value_user">$\${}$</div><br>
            $\$0.0$<br><br>
            $\$0.0$<br><br>
          </div>
          <div id="equal">
            <br><br>$=$
          </div>
          <div id='rhs'>
            <br><br>$\${}$
          </div>
      </div>

      <div id = "pages" class="results">
        <div id="page_value" class="minions">
          <h3>Value of the Pages</h3>
          <div id="PageValue" class ="Q" style="width:480px; height:400px;">
            <table id="pagesTable">
              <thead>
                <tr id='actions'>
                  <!-- need to add actions dynamically -->
                </tr>
              </thead>
              <tbody>
              </tbody>


            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</body>

<!-- setting up inputs -->
  <script>

    $(document).ready(function() {
      var table = $('rewards')
      var max_fields = 3;
      var wrapper = $("#rewards");
      var add_button = $("#update_reward_button");

      new_row = '<tr class="inputs"> \
                    <td class="action"> <input type="text" name="mytext[]"  placeholder="Enter Action" required> </td> \
                    <td class="down"><input type="number" value = "2"></td> \
                    <td class="right"><input type="number" value = "2" ></td> \
                    <td class="dead"><input type="number" value = "2" ></td> \
                    <td class="use_rate"><input type="number" value="0.2"></td> \
                    <td><input type="button" value="Remove Action"></td> \
                  </tr>';

      var x = 1;
      $(add_button).click(function(e) {
        e.preventDefault();
        if(x < max_fields){
          x++;
          $(wrapper).append(new_row);
        }
      });

      $('#rewards').on("click",'input[type="button"]', function(e){
        $(this).closest('tr').remove();
        x--;
      })
    });


  </script>

  <!-- submitting forms -->
 <script>
   function submitForm(){
     var inputs = $('.inputs')
     var out ={action:{},params:{}};
     $.each(inputs, function(t){
       action = $(inputs[t]).find('.action > input')[0].value;
       down = $(inputs[t]).find('.down > input')[0].value;
       dead = $(inputs[t]).find('.dead > input')[0].value;
       right = $(inputs[t]).find('.right > input')[0].value;
       use_rate = $(inputs[t]).find('.use_rate > input')[0].value;
       out.action[action] = {'dead':dead, 'down':down, 'right':right, 'use_rate':use_rate}
     });

     vars=  $('.vars')
     $.each(vars, function(t){
       out.params[vars[t].name] = vars[t].value;
     })

     // for plots
     MAX_SD_COLS = out.params['MAX_SD_COLS']
     MAX_ATSOP_ROWS = out.params['MAX_ATSOP_ROWS']
     ATSOP_GAP = out.params["ATSOP_GAP"]

     x_labels = Array()
     y_labels = Array()
     for(i=1; i<=MAX_SD_COLS; i++){
       x_labels.push(i)
     }

     for(i=MAX_ATSOP_ROWS; i>0; i--){
       y_labels.push(ATSOP_GAP*(i-1) + '-' + ATSOP_GAP*i)
     }

    ACTIONS = Object.keys(out.action)
    $("#pagesTable > thead > tr").empty()
    $("#pagesTable > thead > tr").append("<th> Page </th><th> Session Depth </th>")
    for(i in ACTIONS){
      $("#pagesTable > thead > #actions").append('<th>'+ACTIONS[i]+'</th>')
    }

    $.ajax({
      url:"http://0.0.0.0:9090/loadSetup",
      type: "POST",
      data:JSON.stringify(out),
      contentType:"application/json",
      success:function(response) {
        var newWindow =  window.open("", "_blank");
        newWindow.location.href=response;
        updatePlots(x_labels, y_labels)
      }
    });

   }

 </script>


 <script type="text/javascript"  src="{{ url_for('static', filename='makePlots.js') }}"></script>

 <script>

   $("#update_results").click(function(){
     updatePlots(x_labels, y_labels)
   })

   var QUEUE = MathJax.Hub.queue;
   var money = null;
   var value = null;
   QUEUE.Push(function () {
     money = MathJax.Hub.getAllJax("rhs")[0];
     value = MathJax.Hub.getAllJax("value_user")[0];
   });

   window.updateValue = function(N) {
     var value = parseFloat(MathJax.Hub.getAllJax("value_user")[0].originalText.slice(1))
     console.log(value, N)
     QUEUE.Push(["Text", money, "\\displaystyle{$"+ round(value*N, 2) + "}" ])
   }

  //  QUEUE.Push(["Text", value, "$0.0"])

 </script>

</html>
